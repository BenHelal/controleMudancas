{% extends 'base.html.twig' %}

{% block body %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
    }

    #item-lists {
      list-style-type: none;
      padding: 0;
      margin: 20px;
      border: 1px solid #ccc;
    }

    .draggabled {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px;
      background-color: #f4f4f4;
      cursor: grab;
    }

    select {
      margin-left: 10px;
    }
  </style>


<div class="container mt-3">
    <button class="btn btn-success" style="background-color : #17a2b8" onclick="voltar()">Voltar</button>
</div>

  <ul id="item-lists">
  {% set sortedItems = m|sort((a, b) => a.orderNumber <=> b.orderNumber) %}

{% for item in sortedItems %}
        {% if item.implemented == null %}
    
        <li class="draggabled" data-id="{{ item.id }}">
            <span>Codigo da mudança: {{ item.id }} <br>
                Nome da mudança: {{ item.nomeMudanca }}<br>
            </span>
            {% if item.areaResp.manager != person %}
                {{ item.orderNumber }} <br>
            {% else %}
            <select class="order-select" onchange="changeOrder(this, {{ item.id }})">
                {% for i in 1..m|length %}
                    <option value="{{ i }}" {% if i == item.orderNumber %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
            </select>
            {% endif %}
        </li>
        {% else %}
        
        {% endif %}
    {% endfor %}
</ul>

<script>
    const itemList = document.getElementById('item-lists');

    new Sortable(itemList, {
        animation: 150,
        handle: '.draggabled',
        onUpdate: function (evt) {
            updateOrder(evt.from.children);
            const orderData = getOrderData(itemList);
            updateOrderOnServer(orderData);
        }
    });

    function updateOrder(items) {
        Array.from(items).forEach((item, index) => {
            const orderSelect = item.querySelector('.order-select');
            orderSelect.selectedIndex = index;
        });
    }

function changeOrder(select, itemId) {
    const listItem = select.closest('.draggabled');
    const newIndex = parseInt(select.value) - 1;

    itemList.insertBefore(listItem, itemList.children[newIndex]);
    updateOrder(itemList.children);

    const orderData = getOrderData(itemList);

    // Find the orderData entry for the item being changed
    const changedItem = orderData.find(item => item.id === itemId);
    if (changedItem) {
        changedItem.order = select.value;
    }

    updateOrderOnServer(orderData);
}

    function getOrderData(itemList) {
        const orderData = [];
        Array.from(itemList.children).forEach(item => {
            orderData.push({
                id: item.getAttribute('data-id'),
                order: item.querySelector('.order-select').value
            });
        });
        return orderData;
    }

    function updateOrderOnServer(orderData) {
        // Send AJAX request to update order on the server
        const xhr = new XMLHttpRequest();
        xhr.open('POST', "{{ path('updateorder') }}", true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    console.log('Order updated on the server');
                } else {
                    console.error('Error updating order on the server');
                }
            }
        };

        xhr.send('orderData=' + encodeURIComponent(JSON.stringify(orderData)));
    }
</script>
<!-- Bootstrap JS (opcional, mas necessário para recursos específicos como tooltips) -->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

<script>
    function voltar() {
        window.history.back();
    }
</script>

{% endblock %}